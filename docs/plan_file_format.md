# Overview
A `.plan` file is a newline-delimited command list that drives one retrieval attempt for a single website query.

The app parses commands from the plan, executes them in order, and writes artifacts (screenshots, HTML snapshots, and LLM logs) in the attempt's artifacts directory.

# File Rules
- One command per line.
- Blank lines are allowed.
- Lines starting with `#` or `//` are treated as comments.
- Command arguments are parsed with shell-style quoting (`shlex`), so quoted strings with spaces are supported.
- The parser accepts markdown fences if present, but plain command lines are preferred.
- A plan must contain at least one valid command.

# Command Reference
## `target_site "url"`
Navigates to the target URL and captures an artifact snapshot.

Notes:
- Exactly one argument is required.
- In generated plans, this is always forced to `https://<query-site>`.

## `login_required`
Ensures login before continuing, needed for websites and/or information retrieval tasks that typically require a login.

Behavior:
- First checks login status from a screenshot using an LLM classifier.
- If not logged in, opens a non-headless browser, prompts the user to complete login, and waits for ENTER.
- Returns to headless mode afterward.
- this command is very slow

## `enable_text_entry`
Enables typing for both:
- the explicit `type` command
- LLM-driven typing during `explore_website_openai`

Without this flag, typing attempts fail.

## `explore_website_openai "instruction" max_command_steps`
Runs OpenAI computer-use exploration to gather context.

Arguments:
- `instruction`: exploration objective.
- `max_command_steps`: integer step budget.

Runtime details:
- Step budget is clamped to `1..80`.
- Computer-use actions are mapped immediately to plan interaction commands.
- If computer use emits an action that cannot be mapped (for example `double_click`, `drag`, `move`, or horizontal scroll), the query fails immediately with the offending action in the error text.
- Each exploration action records artifacts and action metadata.
- Exploration summary and step history are written to `exploration_steps.json`.
- this command is very slow

## `click x y`
Left-click at integer pixel coordinates.

## `type "text"`
Types text via keyboard input.

Requirement:
- `enable_text_entry` must appear earlier in the plan.

## `keypress "key1" "key2" ...`
Presses one or more keys in sequence.

Notes:
- Keys are normalized to Playwright key names (for example `ENTER` -> `Enter`, `ctrl+l` -> `Control+L`).
- Useful for interactions like `Enter`, `Tab`, arrow keys, and shortcuts.

## `wait ms`
Sleeps for the given integer milliseconds.

## `vscroll amount`
Vertical mouse-wheel scroll by signed integer amount.

Notes:
- Negative scrolls up.
- Positive scrolls down.

## `answer_query_text "instruction"`
Produces final answer from the 4 most recent HTML page snapshots (`page_*.html`).

Notes:
- If no page snapshots exist yet, one is auto-captured.
- This should usually be the final command.
- this command is very slow

## `answer_query_images "instruction"`
Produces final answer from the 4 most recent screenshots (`screenshot_*.png`).

Notes:
- If no screenshots exist yet, one is auto-captured.
- This should usually be the final command.
- this command is very slow

# Validation Constraints
- Unknown commands are rejected.
- Command argument counts/types must match the definitions above.
- `explore_website_openai` requires an integer step count.
- `click`, `wait`, and `vscroll` require integer arguments.
- At least one answer command should be present (`answer_query_text` or `answer_query_images`).

# Auto-Normalization for Generated Plans
When plans are generated by the planner, they are normalized before execution.

Normalization behavior:
- Forces first command to `target_site "https://<query-site>"`.
- Ensures at least one answer command exists; if missing, adds `answer_query_text`.
- Moves answer commands to the end.
- Ensures at least one pre-answer action exists; inserts `explore_website_openai` if needed.
- Inserts `enable_text_entry` before any `type` command if missing.

# Example (Valid)
```plan
target_site "https://finance.yahoo.com"
enable_text_entry
explore_website_openai "Search for AMZN and open the quote page" 12
answer_query_text "Return the latest traded price for AMZN. If uncertain, start with FAIL and explain what is missing."
```
